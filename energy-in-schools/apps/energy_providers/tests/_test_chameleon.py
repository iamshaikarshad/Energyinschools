import json
from copy import deepcopy

from apps.energy_providers.models import EnergyProviderAccount
from apps.energy_providers.providers.abstract import Meter, MeterType
from apps.energy_providers.providers.chameleon import ChameleonProviderConnection
from apps.energy_providers.tests.base_test_case import EnergyProviderBaseTestCase
from utilities.requests_mock import RequestMock

CHAMELEON_RESPONSE_JSON = {
    'result': {'docs': [{'_id': '3f79dac6ba426481a4b175a7711ad01b', '_rev': '1-a0beea498cd9d9d4c068eb537a7f41b8',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448154, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448141, 'power': 156250},
                                               {'time': 1537448145, 'power': 156250},
                                               {'time': 1537448149, 'power': 156250},
                                               {'time': 1537448153, 'power': 156250}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '3f79dac6ba426481a4b175a77126f13f', '_rev': '1-ee5f94aad36ebc80acceca9f615a277a',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448199, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448185, 'power': 156250},
                                               {'time': 1537448189, 'power': 156250},
                                               {'time': 1537448193, 'power': 156250},
                                               {'time': 1537448197, 'power': 156250}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '3f79dac6ba426481a4b175a77132bc6e', '_rev': '1-443eae673b79a7ad7124a9b7580980bc',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448244, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448229, 'power': 156300},
                                               {'time': 1537448233, 'power': 156300},
                                               {'time': 1537448237, 'power': 156300},
                                               {'time': 1537448241, 'power': 156300}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '3f79dac6ba426481a4b175a77133bc81', '_rev': '1-e571d3a901f3548f96a444e24924dc74',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448259, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448245, 'power': 156300},
                                               {'time': 1537448249, 'power': 156300},
                                               {'time': 1537448253, 'power': 156300},
                                               {'time': 1537448257, 'power': 156300}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '44f4c546cad818a31cff8b76295f7ab3', '_rev': '1-d549a04a63d55d5cac449bbf1a885792',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448229, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448217, 'power': 156300},
                                               {'time': 1537448221, 'power': 156300},
                                               {'time': 1537448225, 'power': 156300}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '44f4c546cad818a31cff8b76296ef703', '_rev': '1-8bedf41d58911ac5ecf7520c7a863ba4',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448304, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448289, 'power': 156350},
                                               {'time': 1537448293, 'power': 156350},
                                               {'time': 1537448297, 'power': 156350},
                                               {'time': 1537448301, 'power': 156350}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '44f4c546cad818a31cff8b7629993395', '_rev': '1-0d3b54f77752fe1788c569fc2b77aca2',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448503, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448489, 'power': 156500},
                                               {'time': 1537448493, 'power': 156500},
                                               {'time': 1537448497, 'power': 156500},
                                               {'time': 1537448501, 'power': 156500}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '44f4c546cad818a31cff8b7629adbf76', '_rev': '1-b695a96ef94196640a7d93f153afd6c7',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448518, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448505, 'power': 156550},
                                               {'time': 1537448509, 'power': 156550},
                                               {'time': 1537448513, 'power': 156550},
                                               {'time': 1537448517, 'power': 156550}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '623ae11cd93382afc5bb7cd783207a32', '_rev': '1-1b3c5ce008f6646bc9ba123db0b07607',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537447974, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537447961, 'power': 156100},
                                               {'time': 1537447965, 'power': 156100},
                                               {'time': 1537447969, 'power': 156100},
                                               {'time': 1537447973, 'power': 156100}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '623ae11cd93382afc5bb7cd78321cdfb', '_rev': '1-b80761f06ba4efc73801f0a313838c10',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537447989, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537447977, 'power': 156100},
                                               {'time': 1537447981, 'power': 156100},
                                               {'time': 1537447985, 'power': 156100}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '623ae11cd93382afc5bb7cd783405b8e', '_rev': '1-e602507fd2c9c8ba0ffb629be581fa48',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448109, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448097, 'power': 156200},
                                               {'time': 1537448101, 'power': 156200},
                                               {'time': 1537448105, 'power': 156200}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '623ae11cd93382afc5bb7cd7839931d4', '_rev': '1-bf32155669c0f0e4c6ecd00f592f723a',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448214, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448201, 'power': 156300},
                                               {'time': 1537448205, 'power': 156300},
                                               {'time': 1537448209, 'power': 156300},
                                               {'time': 1537448213, 'power': 156300}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '623ae11cd93382afc5bb7cd783b00d36', '_rev': '1-15589e10461b644f73ba7b91acda5b6c',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448379, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448365, 'power': 156400},
                                               {'time': 1537448369, 'power': 156400},
                                               {'time': 1537448373, 'power': 156400},
                                               {'time': 1537448377, 'power': 156400}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '623ae11cd93382afc5bb7cd783c81c1b', '_rev': '1-0f9c0bada421c7624d47ab083df309bf',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448458, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448445, 'power': 156500},
                                               {'time': 1537448449, 'power': 156500},
                                               {'time': 1537448453, 'power': 156500},
                                               {'time': 1537448457, 'power': 156500}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '623ae11cd93382afc5bb7cd783ddce56', '_rev': '1-acd98efa6ea7f0b8d274c15978669f61',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448488, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448473, 'power': 156500},
                                               {'time': 1537448477, 'power': 156500},
                                               {'time': 1537448481, 'power': 156500},
                                               {'time': 1537448485, 'power': 156500}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '68e53d84a31ac2bcb8ba1267ddf7d430', '_rev': '1-17db6780637515c3737b3ede425f5e83',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537447959, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537447945, 'power': 156050},
                                               {'time': 1537447949, 'power': 156050},
                                               {'time': 1537447953, 'power': 156050},
                                               {'time': 1537447957, 'power': 156050}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '792d7b88406ea564ed879949c5f67ac1', '_rev': '1-9f3524d3f2496031892796563d4dc186',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448334, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448321, 'power': 156400},
                                               {'time': 1537448325, 'power': 156400},
                                               {'time': 1537448329, 'power': 156400},
                                               {'time': 1537448333, 'power': 156400}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '79f0d44b22b5952b70aed70654042d1b', '_rev': '1-007db5ee9a96fe83066436d8027d9681',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448094, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448081, 'power': 156200},
                                               {'time': 1537448085, 'power': 156200},
                                               {'time': 1537448089, 'power': 156200},
                                               {'time': 1537448093, 'power': 156200}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '84bca342abaa831a69f6bcbb315da6f6', '_rev': '1-61c59e102a6aad0628eb87d117412b02',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448184, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448169, 'power': 156250},
                                               {'time': 1537448173, 'power': 156250},
                                               {'time': 1537448177, 'power': 156250},
                                               {'time': 1537448181, 'power': 156250}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '84bca342abaa831a69f6bcbb319cdc5b', '_rev': '1-c2f99132d2875b78217344542e80c878',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448349, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448337, 'power': 156400},
                                               {'time': 1537448341, 'power': 156400},
                                               {'time': 1537448345, 'power': 156400}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '84bca342abaa831a69f6bcbb319dfa81', '_rev': '1-f3e31c7017888fb5e163845f73a85f28',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448364, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448349, 'power': 156400},
                                               {'time': 1537448353, 'power': 156400},
                                               {'time': 1537448357, 'power': 156400},
                                               {'time': 1537448361, 'power': 156400}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': '84bca342abaa831a69f6bcbb31a22ee4', '_rev': '1-274118ba3a79e00ddc555fab5338e631',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448413, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448397, 'power': 156450},
                                               {'time': 1537448401, 'power': 156450},
                                               {'time': 1537448409, 'power': 156450}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'a5fc2b30a9a21c332ff563760842006f', '_rev': '1-ac8bb23703131375310bbc5a14377242',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448034, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448021, 'power': 156150},
                                               {'time': 1537448025, 'power': 156150},
                                               {'time': 1537448029, 'power': 156150},
                                               {'time': 1537448033, 'power': 156150}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'a5fc2b30a9a21c332ff5637608446212', '_rev': '1-2e2ac02e91eab0baf82039da8c6a1613',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448049, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448037, 'power': 156150},
                                               {'time': 1537448041, 'power': 156150},
                                               {'time': 1537448045, 'power': 156150}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'c36ff10e48ec9431377e6add9401eefd', '_rev': '1-13c5376980503cc54982a954bb4e42f7',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448533, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448521, 'power': 156550},
                                               {'time': 1537448525, 'power': 156550},
                                               {'time': 1537448529, 'power': 156550}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'c36ff10e48ec9431377e6add94033e60', '_rev': '1-cb2868d4a20ed3bd0a5b9a85a35ee64f',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448548, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448533, 'power': 156550},
                                               {'time': 1537448537, 'power': 156550},
                                               {'time': 1537448541, 'power': 156550},
                                               {'time': 1537448545, 'power': 156550}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'c8f51cd2b924940ffc690847abf4ddbf', '_rev': '1-7b26bcf2cd3bf73bef08497ac9a7c9f7',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448124, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448109, 'power': 156200},
                                               {'time': 1537448113, 'power': 156200},
                                               {'time': 1537448117, 'power': 156200},
                                               {'time': 1537448121, 'power': 156200}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'cf3ccd7aa755422282ec3b0eec6689ae', '_rev': '1-8a049a2f412dbc4b25b9fd00669f74e5',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448004, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537447989, 'power': 156100},
                                               {'time': 1537447993, 'power': 156100},
                                               {'time': 1537447997, 'power': 156100},
                                               {'time': 1537448001, 'power': 156100}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'cf3ccd7aa755422282ec3b0eec6a66e9', '_rev': '1-9371d9baa0c5d13f5ae8534853807ca3',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448079, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448065, 'power': 156150},
                                               {'time': 1537448069, 'power': 156150},
                                               {'time': 1537448073, 'power': 156150},
                                               {'time': 1537448077, 'power': 156150}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'cf3ccd7aa755422282ec3b0eec802ab7', '_rev': '1-f045d4b6bd682d12dd34c86eae26c11d',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448139, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448125, 'power': 156200},
                                               {'time': 1537448129, 'power': 156200},
                                               {'time': 1537448133, 'power': 156200},
                                               {'time': 1537448137, 'power': 156200}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'cf3ccd7aa755422282ec3b0eecb69342', '_rev': '1-cd8059f0d822776aef5cb66546f6d499',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448274, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448261, 'power': 156350},
                                               {'time': 1537448265, 'power': 156350},
                                               {'time': 1537448269, 'power': 156350},
                                               {'time': 1537448273, 'power': 156350}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'cf3ccd7aa755422282ec3b0eecb92cdd', '_rev': '1-fe485c2ab3293947f33c8b515d0b2ae7',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448319, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448305, 'power': 156350},
                                               {'time': 1537448309, 'power': 156350},
                                               {'time': 1537448313, 'power': 156350},
                                               {'time': 1537448317, 'power': 156350}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'cf3ccd7aa755422282ec3b0eecc94366', '_rev': '1-b8d2b1282d634bb79dc7845c1b41fc7a',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448443, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448429, 'power': 156450},
                                               {'time': 1537448433, 'power': 156450},
                                               {'time': 1537448437, 'power': 156450},
                                               {'time': 1537448441, 'power': 156450}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'ddeba57487123571f9b38bc752303efc', '_rev': '1-30678e4d1e20403b841a9bc262d0ef8f',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448289, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448277, 'power': 156350},
                                               {'time': 1537448281, 'power': 156350},
                                               {'time': 1537448285, 'power': 156350}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'ddeba57487123571f9b38bc7523546be', '_rev': '1-5cfdb21060bc10eef2099734414115d5',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448394, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448381, 'power': 156450},
                                               {'time': 1537448385, 'power': 156450},
                                               {'time': 1537448389, 'power': 156450},
                                               {'time': 1537448393, 'power': 156450}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'ddeba57487123571f9b38bc7525192a4', '_rev': '1-1159f3a0c2b681882f33ea042626ae50',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448428, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448413, 'power': 156450},
                                               {'time': 1537448417, 'power': 156450},
                                               {'time': 1537448421, 'power': 156450},
                                               {'time': 1537448425, 'power': 156450}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'ddeba57487123571f9b38bc752664475', '_rev': '1-5659e84ef222b3266da284b744d6e552',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448473, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448461, 'power': 156500},
                                               {'time': 1537448465, 'power': 156500},
                                               {'time': 1537448469, 'power': 156500}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'e3f3efdec5b2e469756f53d9c5b5def5', '_rev': '1-b90cd547e180f01650a7718d489bc685',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448019, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448005, 'power': 156100},
                                               {'time': 1537448009, 'power': 156100},
                                               {'time': 1537448013, 'power': 156100},
                                               {'time': 1537448017, 'power': 156100}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'e3f3efdec5b2e469756f53d9c5b82e69', '_rev': '1-89f3b6be1a9f53464eaf15aa6f5cebf3',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448064, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448049, 'power': 156150},
                                               {'time': 1537448053, 'power': 156150},
                                               {'time': 1537448057, 'power': 156150},
                                               {'time': 1537448061, 'power': 156150}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'},
                        {'_id': 'e3f3efdec5b2e469756f53d9c5ce7d3b', '_rev': '1-5a8fabb84ea88230f401e83c07621392',
                         'topic': 'iot-2/type/BCAD/id/DEMO1B/evt/power/fmt/json',
                         'payload': {'time': 1537448169, 'commodity': 'elec', 'period': 15, 'losses': False,
                                     'power': [{'time': 1537448157, 'power': 156250},
                                               {'time': 1537448161, 'power': 156250},
                                               {'time': 1537448165, 'power': 156250}], 'ambient': 'green'},
                         'deviceId': 'DEMO1B', 'deviceType': 'BCAD', 'eventType': 'power', 'format': 'json'}],
               'bookmark': 'g2wAAAACaAJkAA5zdGFydGtleV9kb2NpZG0AAAAgZTNmM2VmZGVjNWIyZTQ2OTc1NmY1M2Q5YzVjZTdkM2JoAmQACHN0YXJ0a2V5bAAAAAFtAAAABXBvd2Vyamo'}
}

USAGE_REQUEST_MOCK = RequestMock(
    request_url=f'https://chiotests-fkdeov345.mybluemix.net/raw/api/cad/events',
    request_method=RequestMock.Method.POST,
    response_json=CHAMELEON_RESPONSE_JSON
)

CHAMELEON_RESPONSE_JSON_DIFF = deepcopy(CHAMELEON_RESPONSE_JSON)
CHAMELEON_RESPONSE_JSON_DIFF['result']['docs'][0]['payload']['power'][0]['power'] = 10000000

USAGE_REQUEST_MOCK_DIFFERENT = RequestMock(
    request_url=f'https://chiotests-fkdeov345.mybluemix.net/raw/api/cad/events',
    request_method=RequestMock.Method.POST,
    response_json=CHAMELEON_RESPONSE_JSON_DIFF
)


class TestChameleonProvider(EnergyProviderBaseTestCase):
    """
        XXX TODO REMOVE CACHING FOR TESTS
    """
    provider = EnergyProviderAccount.Provider.CHAMELEON

    @RequestMock.assert_requests([USAGE_REQUEST_MOCK])
    def test_get_consumption_cached(self):
        values_prepared = list(
            [entry['power'] for doc in USAGE_REQUEST_MOCK.response_json['result']['docs'] for entry in
             doc['payload']['power']])
        values = []
        for index in range(10):
            value = self.energy_provider.connection.get_consumption(Meter(
                meter_id='any',
                type=MeterType.ELECTRICITY
            ))
            values.append(value[1])

        self.assertEqual(values_prepared[:10], values)

    @RequestMock.assert_requests([USAGE_REQUEST_MOCK, USAGE_REQUEST_MOCK_DIFFERENT])
    def test_get_consumption_without_cache(self):
        prev_value = 0
        for _ in range(2):
            ChameleonProviderConnection.call_api.invalidate_all()
            value = self.energy_provider.connection.get_consumption(Meter(
                meter_id='any',
                type=MeterType.GAS
            ))
            self.assertNotEqual(value, prev_value) # SHOULD BE 1000000 TODO REPLACE BETTER CHECK
            prev_value = value
